# 📐 SCHEME ȘI DIAGRAME - SISTEM DETECȚIE INUNDAȚII

---

## 1. SCHEMA BLOC SISTEM

```
╔══════════════════════════════════════════════════════════════════════╗
║                    SISTEM DE DETECȚIE INUNDAȚII                      ║
║                     STM32F429I-DISCO + FreeRTOS                      ║
╚══════════════════════════════════════════════════════════════════════╝

┌──────────────────────────────────────────────────────────────────────┐
│                         SENZORI (INPUT)                              │
├──────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  ┌──────────────┐         ┌──────────────┐                         │
│  │    DHT22     │         │    YL-83     │                         │
│  │  (AM2302)    │         │ Water Sensor │                         │
│  ├──────────────┤         ├──────────────┤                         │
│  │ VCC → 3.3V   │         │ VCC → 3.3V   │                         │
│  │ DATA → PG9   │         │ DO  → PG12   │                         │
│  │ GND → GND    │         │ GND → GND    │                         │
│  └──────┬───────┘         └──────┬───────┘                         │
│         │                        │                                  │
│         │  Protocol 1-Wire       │  Digital HIGH/LOW                │
│         │  (Half-Duplex)         │                                  │
└─────────┼────────────────────────┼──────────────────────────────────┘
          │                        │
          ▼                        ▼
┌──────────────────────────────────────────────────────────────────────┐
│                   MICROCONTROLER STM32F429ZIT6                       │
│                      ARM Cortex-M4F @ 180 MHz                        │
├──────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  ┌────────────────────────────────────────────────────────────┐    │
│  │                    FREERTOS RTOS                            │    │
│  ├────────────────────────────────────────────────────────────┤    │
│  │                                                             │    │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐    │    │
│  │  │   Task 1     │  │   Task 2     │  │   Task 3     │    │    │
│  │  │ ReadDHT22    │  │ CheckFlood   │  │ ControlOut   │    │    │
│  │  ├──────────────┤  ├──────────────┤  ├──────────────┤    │    │
│  │  │ Prioritate:  │  │ Prioritate:  │  │ Prioritate:  │    │    │
│  │  │   Normal     │  │   Normal     │  │   Normal     │    │    │
│  │  │ Stack: 1KB   │  │ Stack: 1KB   │  │ Stack: 1KB   │    │    │
│  │  │ Perioadă:    │  │ Perioadă:    │  │ Perioadă:    │    │    │
│  │  │   2000 ms    │  │   500 ms     │  │   100 ms     │    │    │
│  │  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘    │    │
│  │         │                 │                 │             │    │
│  │         └─────────────────┴─────────────────┘             │    │
│  │                           │                                │    │
│  │  ┌────────────────────────▼─────────────────────────┐     │    │
│  │  │            Variabile Globale Partajate           │     │    │
│  │  ├──────────────────────────────────────────────────┤     │    │
│  │  │  volatile float g_temperature = 0.0f;            │     │    │
│  │  │  volatile float g_humidity = 0.0f;               │     │    │
│  │  │  volatile uint8_t g_flood_detected = 0;          │     │    │
│  │  └────────────────────────┬─────────────────────────┘     │    │
│  │                           │                                │    │
│  │  ┌────────────────────────▼─────────────────────────┐     │    │
│  │  │                   Task GUI                       │     │    │
│  │  │                 (TouchGFX)                       │     │    │
│  │  ├──────────────────────────────────────────────────┤     │    │
│  │  │ Prioritate: Normal                               │     │    │
│  │  │ Stack: 32 KB                                     │     │    │
│  │  │ Actualizare: Screen1View                         │     │    │
│  │  └────────────────────────┬─────────────────────────┘     │    │
│  └───────────────────────────┼───────────────────────────────┘    │
│                              │                                     │
│  ┌───────────────────────────▼───────────────────────────────┐    │
│  │              LTDC + DMA2D (Display Controller)            │    │
│  │  ┌─────────────────────────────────────────────────────┐  │    │
│  │  │ Framebuffer 1 (150 KB SDRAM @ 0xD0000000)          │  │    │
│  │  │ Framebuffer 2 (150 KB SDRAM @ 0xD0025800)          │  │    │
│  │  └─────────────────────────────────────────────────────┘  │    │
│  └────────────────────────────┬──────────────────────────────┘    │
└─────────────────────────────────┼──────────────────────────────────┘
                                 │
                                 │ Paralel (16/18 bit)
                                 ▼
┌──────────────────────────────────────────────────────────────────────┐
│                    AFIȘAJ LCD (OUTPUT)                               │
├──────────────────────────────────────────────────────────────────────┤
│  ┌────────────────────────────────────────────────────┐             │
│  │            ILI9341 LCD Controller                  │             │
│  │            320x240 pixeli, 16 bpp                  │             │
│  ├────────────────────────────────────────────────────┤             │
│  │                                                    │             │
│  │    ┌──────────────────────────────────┐           │             │
│  │    │       Logo 180x200               │           │             │
│  │    └──────────────────────────────────┘           │             │
│  │                                                    │             │
│  │    🌡️ Temperatură: [XX.X]°C                     │             │
│  │    💧 Umiditate:   [XX.X]%                       │             │
│  │                                                    │             │
│  │    Status: [Normal / INUNDAȚIE!]                  │             │
│  │                                                    │             │
│  └────────────────────────────────────────────────────┘             │
└──────────────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────────────┐
│                     ACTUATORI (OUTPUT)                               │
├──────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  STM32 PG14 ──┐                    STM32 PG13 ──┐                   │
│               │                                  │                   │
│               ▼                                  ▼                   │
│  ┌────────────────────┐              ┌────────────────────┐         │
│  │   RELEU MODULE     │              │      BUZZER        │         │
│  ├────────────────────┤              ├────────────────────┤         │
│  │ IN  ← PG14         │              │ (+) ← PG13         │         │
│  │ VCC ← 5V           │              │ (-) ← GND          │         │
│  │ GND ← GND          │              └────────────────────┘         │
│  │                    │                                             │
│  │ COM ───┐           │              Frecvență: 2-4 kHz             │
│  │ NO  ───┼──► LOAD   │              Volum: ~85 dB                  │
│  │ NC  ───┘           │              Tip: Passive Buzzer            │
│  └────────────────────┘                                             │
│                                                                      │
│  Poate comanda:                                                     │
│  - Pompă evacuare apă                                               │
│  - Ventilator răcire                                                │
│  - Alarmă externă 220V                                              │
│  - Electrovalvă închidere apă                                       │
│                                                                      │
└──────────────────────────────────────────────────────────────────────┘
```

---

## 2. TIMING DIAGRAM - PROTOCOL DHT22

```
┌─────────────────────────────────────────────────────────────────────┐
│              SECVENȚĂ COMUNICAȚIE DHT22 (1-Wire)                    │
└─────────────────────────────────────────────────────────────────────┘

Timp (ms) │
    0     │
          │  MCU: Trage pin LOW (Start Signal)
          │  ▼
    1.1   │  ────┐
          │      │
          │      └──────────────────────── (LOW > 1ms)
          │
    1.13  │  MCU: Eliberează pin (HIGH)
          │  ────────┐
          │          │  ▲
          │          │  20-40 μs
          │          └────
          │
          │  DHT22: Preia controlul
          │
    ~1.14 │  ─────────┐
          │           │  ▲
          │           │  80 μs (Response LOW)
          │           └─────────┐
          │                     │  ▲
          │                     │  80 μs (Response HIGH)
          │                     └─────┐
          │
          │  Transmisie DATE (40 biți)
          │
    ~1.20 │  ┐ ┌─┐ ┌─┐ ┌─────┐ ┌─┐ ...
          │  └─┘ └─┘ └─┘     └─┘ └─┘
          │  │   │   │         │
          │  │   │   │         └── Bit '1' (HIGH ~70 μs)
          │  │   │   └──────────── Bit '0' (HIGH ~28 μs)
          │  │   └────────────────  Inter-bit LOW (~50 μs)
          │  └────────────────────  Start bit (LOW)
          │
    ~1.25 │  Sfârșit transmisie (40 biți)
          │  ──────────────────────
          │
          │

DECODARE BITI:
┌─────────────────────────────────────────────────────────┐
│  Bit '0':                    Bit '1':                   │
│  ┌───┐                       ┌───┐                      │
│  │   │                       │   │                      │
│──┘   └── (HIGH ~28 μs)       │   │                      │
│                          ────┘   └──── (HIGH ~70 μs)    │
│                                                          │
│  ├──┤ 26-28 μs               ├────────┤ 70 μs           │
└─────────────────────────────────────────────────────────┘

DATE TRANSMISE (5 octeți = 40 biți):
┌─────────┬─────────┬─────────┬─────────┬─────────┐
│ Byte 0  │ Byte 1  │ Byte 2  │ Byte 3  │ Byte 4  │
├─────────┼─────────┼─────────┼─────────┼─────────┤
│ Hum MSB │ Hum LSB │ Temp MSB│ Temp LSB│Checksum │
└─────────┴─────────┴─────────┴─────────┴─────────┘
   8 bit     8 bit     8 bit     8 bit     8 bit

EXEMPLU CALCUL:
- Byte0 = 0x01, Byte1 = 0xC2 → Umiditate = (0x01C2 = 450) / 10 = 45.0%
- Byte2 = 0x00, Byte3 = 0xF5 → Temperatură = (0x00F5 = 245) / 10 = 24.5°C
- Checksum = (Byte0 + Byte1 + Byte2 + Byte3) & 0xFF
```

---

## 3. STATE MACHINE - TASK CONTROL OUTPUTS

```
┌──────────────────────────────────────────────────────────────┐
│          DIAGRAMĂ STĂRI - CONTROL RELEU ȘI BUZZER           │
└──────────────────────────────────────────────────────────────┘

                    ┌─────────────────┐
                    │   POWER-ON      │
                    │  (Inițializare) │
                    └────────┬────────┘
                             │
                             ▼
                    ┌─────────────────┐
              ┌─────┤   IDLE STATE    │◄─────┐
              │     │  (Fără Alarmă)  │      │
              │     ├─────────────────┤      │
              │     │ Releu: OFF      │      │
              │     │ Buzzer: OFF     │      │
              │     │ g_flood = 0     │      │
              │     └────────┬────────┘      │
              │              │                │
              │              │ [Water detected]
              │              │ g_flood_detected = 1
              │              ▼                │
              │     ┌─────────────────┐      │
              │     │  ALERT STATE    │      │
              │     │ (Inundație!)    │      │
              │     ├─────────────────┤      │
              │     │ Releu: ON       │      │
              │     │ Buzzer: ON      │      │
              │     │ g_flood = 1     │      │
              │     └────────┬────────┘      │
              │              │                │
              │              │ [Water cleared]
              │              │ g_flood_detected = 0
              └──────────────┴────────────────┘

CONDIȚII TRANZIȚIE:
┌────────────────────────────────────────────────────────────┐
│ IDLE → ALERT:                                              │
│   IF (HAL_GPIO_ReadPin(WATER_SENSOR_Pin) == HIGH)         │
│   THEN g_flood_detected = 1                               │
│                                                            │
│ ALERT → IDLE:                                             │
│   IF (HAL_GPIO_ReadPin(WATER_SENSOR_Pin) == LOW)          │
│   THEN g_flood_detected = 0                               │
└────────────────────────────────────────────────────────────┘

TIMP REACȚIE:
- Verificare senzor: 500 ms (Task CheckFlood)
- Activare output:   100 ms (Task ControlOut)
- Total worst-case:  600 ms (de la detectare la activare)
```

---

## 4. MEMORY MAP - STM32F429ZIT6

```
┌──────────────────────────────────────────────────────────────┐
│                   HARTA MEMORIEI STM32F429                   │
└──────────────────────────────────────────────────────────────┘

0xFFFFFFFF  ┌──────────────────────────────────────┐
            │        System Memory (ROM)            │
            │       (Bootloader ST-Link)            │
0xE0000000  ├──────────────────────────────────────┤
            │        Peripheral Memory              │
            │    (GPIO, UART, I2C, SPI, etc.)       │
0xA0000000  ├──────────────────────────────────────┤
            │            Reserved                   │
0xD0000000  ├──────────────────────────────────────┤
            │       EXTERNAL SDRAM (8 MB)           │ ◄── FRAMEBUFFERS
            ├──────────────────────────────────────┤
            │ 0xD0000000: Framebuffer 1 (150 KB)   │
            │ 0xD0025800: Framebuffer 2 (150 KB)   │
            │ 0xD004B000: Scratch Buffer (200 KB)  │
            │ 0xD007D800: FreeRTOS Heap (256 KB)   │ ◄── HEAP_4
            │ 0xD00BD800: Reserved (~7.2 MB free)  │
0xD07FFFFF  └──────────────────────────────────────┘
0x60000000  ┌──────────────────────────────────────┐
            │       External Memory (FMC)           │
            │          (NOR/NAND/SRAM)              │
0x40000000  ├──────────────────────────────────────┤
            │      Peripheral Registers             │
            │  (GPIOA-K, TIM, ADC, DMA, etc.)       │
0x20000000  ├──────────────────────────────────────┤
            │    INTERNAL SRAM (256 KB)             │ ◄── STACK + .bss
            ├──────────────────────────────────────┤
            │ 0x20000000: .data (init vars) 864 B  │
            │ 0x20000360: .bss (uninit) 544 KB     │
            │ 0x20088360: Task stacks               │
            │   - GUI_Task: 32 KB                   │
            │   - Task_CheckFlood: 1 KB             │
            │   - Task_ControlOut: 1 KB             │
            │   - Task_ReadDHT22: 1 KB              │
            │   - DefaultTask: 512 B                │
            │ 0x2003FFFF: End of SRAM               │
0x2003FFFF  └──────────────────────────────────────┘
0x08000000  ┌──────────────────────────────────────┐
            │       FLASH MEMORY (2 MB)             │ ◄── CODE + CONST
            ├──────────────────────────────────────┤
            │ 0x08000000: Vector Table (512 B)     │
            │ 0x08000200: .text (code) 293 KB      │
            │ 0x08049000: .rodata (const data)     │
            │   - Fonturi Verdana (10/20/40 pt)    │
            │   - Logo personalizat (180x200)      │
            │   - String constants                  │
            │ 0x080D0000: Unused (~1.2 MB free)    │
0x081FFFFF  └──────────────────────────────────────┘

TOTAL USAGE:
- Flash: 294 KB / 2048 KB (14.4%)
- SRAM:  256 KB / 256 KB (100% - include stack-uri)
- SDRAM: 806 KB / 8192 KB (9.8%)
```

---

## 5. FLOWCHART - TASK READ DHT22

```
┌──────────────────────────────────────────────────────────┐
│              FLUXUL TASK-ULUI READ DHT22                 │
└──────────────────────────────────────────────────────────┘

        ┌────────────┐
        │   START    │
        │  (Task)    │
        └─────┬──────┘
              │
              ▼
        ┌────────────┐
        │ osDelay    │
        │  (100 ms)  │  ◄──────────────────────┐
        └─────┬──────┘                         │
              │                                │
              ▼                                │
        ┌──────────────────┐                  │
        │ DHT22_Read()     │                  │
        │ (&temp, &hum)    │                  │
        └─────┬────────────┘                  │
              │                                │
              ▼                                │
        ┌────────────┐   NO                   │
        │  Success?  ├──────┐                 │
        │  (ret==1)  │      │                 │
        └─────┬──────┘      │                 │
              │ YES         │                 │
              ▼             ▼                 │
        ┌──────────────────────┐              │
        │ g_temperature = temp │              │
        │ g_humidity = hum     │              │
        └─────┬────────────────┘              │
              │                                │
              ▼                                │
        ┌──────────────────────┐              │
        │ Screen1View*         │              │
        │ ->updateTemp(temp)   │              │
        └─────┬────────────────┘              │
              │                                │
              ▼                                │
        ┌──────────────────────┐              │
        │ Screen1View*         │              │
        │ ->updateHum(hum)     │              │
        └─────┬────────────────┘              │
              │                                │
              ▼                                │
        ┌────────────┐                        │
        │ osDelay    │                        │
        │ (2000 ms)  │ ─────────────────────►┘
        └────────────┘

NOTĂ: Task rulează la fiecare 2 secunde (interval minim DHT22)
```

---

**📄 Sfârșitul fișierului de scheme și diagrame**

*Pentru detalii implementare, vezi DOCUMENTATIE_PROIECT.md*
